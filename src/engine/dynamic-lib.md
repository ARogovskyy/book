Use Rhai in Dynamic Libraries
=============================

{{#include ../links.md}}

[`ahash`]: https://crates.io/crates/ahash

Sometimes functions registered into a Rhai [`Engine`] come from _dynamic libraries_ (a.k.a. _shared
libraries_ in Linux or _DLL's_ in Windows), which are compiled separately from the main binary, not
statically linked but loaded dynamically at runtime.

~~~admonish example.small "`rhai-dylib`"

The project [`rhai-dylib`] demonstrates an API for creating dynamically-loadable libraries
for use with a Rhai [`Engine`].
~~~


Problem Symptom
---------------

The symptom is usually _Function Not Found_ errors even though the relevant functions (within the
dynamic library) have already been registered into the [`Engine`].

This usually happens when a mutable reference to the [`Engine`] is passed into an entry-point
function exposed by the dynamic library and the [`Engine`]'s function registration API is called
inside the dynamic library.


Problem Cause
-------------

To counter DOS attacks, the _hasher_ used by Rhai, [`ahash`], automatically generates a different
_seed_ for hashing during each compilation and execution run.

This means that hash values generated by the hasher will not be _stable_ &ndash; they change
during each compile, and during each run.

This creates hash mismatches between the main binary and the loaded dynamic library because, as they
are not linked together at compile time, two independent copies of the hasher reside in them,
resulting in different hashes for even the same function signature.


Force Stable Hashing
--------------------

When stable hashing is enabled, all hashing uses a fixed, predictable seed all the time.
This means that the same function signature _always_ generate the same hash value.

That seed can be specified via the environment variable `RHAI_AHASH_SEED` and requires four
64-bit numbers (i.e. `u64`) in Rust array literal format.

```bash
RHAI_AHASH_SEED="[123, 456, 789, 42]" cargo build ...
```

The seed specified in `RHAI_AHASH_SEED` is always used to initialize the hasher.

If the environment variable is missing, or it contains all zeros (i.e. `[0, 0, 0, 0]`),
then stable hashing is disabled.

```admonish warning.small "Warning: Safety considerations"

Stable hashing allows dynamic libraries with Rhai code to be loaded and used with
an [`Engine`] in the main binary.

However, a fixed seed enlarges the attack surface of Rhai to malicious intent
(e.g. DOS attacks).

This safety trade-off should be carefully considered.
```

~~~admonish question.small "TL;DR: Why can't we just tell `ahash` to use a fixed seed?"

For fixed hashing seed, [`ahash`] requires:

* `default-features = false`
* `runtime-rng` feature is _not_ set (default on)
* `compile-time-rng` feature is _not_ set

#### The bane of additive Cargo features

However, [`ahash`] is also extremely popular, used by many many other crates,
most notably [`hashbrown`](https://crates.io/crates/hashbrown).

Chances are that there are dependency crates that in turn depend on [`ahash`] with
default features. Since cargo features are _additive_, it is almost certain that [`ahash`]
will use a runtime-generated seed for large projects.

Hence, there exists a need to tell [`ahash`] to use a fixed seed, even when its feature flags
say otherwise.
~~~
